<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3c72">
    <title>Weather</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-gradient: linear-gradient(135deg, #1e3c72, #2a5298);
        }

        html, body {
            min-height: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        html {
            background: var(--bg-gradient);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #fff;
            background: transparent;
            overflow-y: auto;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            padding-top: calc(env(safe-area-inset-top) + 20px);
            padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
            padding-left: calc(env(safe-area-inset-left) + 20px);
            padding-right: calc(env(safe-area-inset-right) + 20px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .location {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .datetime {
            font-size: 14px;
            opacity: 0.8;
        }

        .current-weather {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .weather-icon {
            font-size: 80px;
            margin-bottom: 10px;
        }

        .condition {
            font-size: 20px;
            margin-bottom: 20px;
            text-transform: capitalize;
        }

        .temperature-main {
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 20px;
            margin-bottom: 10px;
        }

        .temp-celsius {
            font-size: 64px;
            font-weight: 200;
        }

        .temp-fahrenheit {
            font-size: 40px;
            font-weight: 200;
            opacity: 0.7;
        }

        .temp-divider {
            font-size: 40px;
            opacity: 0.5;
        }

        .feels-like {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 10px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .detail-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .detail-label {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 500;
        }

        .detail-secondary {
            font-size: 13px;
            opacity: 0.7;
            margin-top: 3px;
        }

        .forecast {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .forecast-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .forecast-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .forecast-day {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .forecast-day-name {
            font-size: 16px;
            width: 80px;
        }

        .forecast-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        .forecast-temps {
            display: flex;
            gap: 10px;
            align-items: baseline;
            width: 150px;
            justify-content: flex-end;
        }

        .forecast-high {
            font-size: 16px;
            font-weight: 500;
        }

        .forecast-low {
            font-size: 14px;
            opacity: 0.6;
        }

        .forecast-rain {
            font-size: 13px;
            color: #fff;
            opacity: 0.85;
            width: 55px;
            text-align: center;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            padding: 20px;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .error-message {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .retry-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .retry-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .refresh-button {
            position: fixed;
            top: calc(env(safe-area-inset-top) + 15px);
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, background 0.2s;
            z-index: 100;
        }

        .refresh-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .refresh-button.spinning {
            animation: spin 1s linear infinite;
        }

        .hourly-forecast {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .hourly-list {
            display: flex;
            gap: 20px;
            padding-bottom: 10px;
        }

        .hourly-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
            gap: 8px;
        }

        .hourly-time {
            font-size: 14px;
            opacity: 0.8;
        }

        .hourly-icon {
            font-size: 24px;
        }

        .hourly-temp {
            font-size: 16px;
            font-weight: 500;
        }

        .hourly-temp-secondary {
            font-size: 12px;
            opacity: 0.6;
        }

        /* Background gradients for different weather conditions */
        html.clear-day { --bg-gradient: linear-gradient(135deg, #2193b0, #6dd5ed); }
        html.clear-night { --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364); }
        html.cloudy { --bg-gradient: linear-gradient(135deg, #616161, #9bc5c3); }
        html.rainy { --bg-gradient: linear-gradient(135deg, #373b44, #4286f4); }
        html.snowy { --bg-gradient: linear-gradient(135deg, #e6dada, #274046); }
        html.stormy { --bg-gradient: linear-gradient(135deg, #232526, #414345); }
    </style>
</head>
<body>
    <button class="refresh-button" id="refresh-btn" title="Refresh">&#x21bb;</button>

    <div class="container" id="app">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Getting your location...</p>
        </div>
    </div>

    <script>
        // Weather code to icon/description mapping
        const weatherCodes = {
            0: { icon: '‚òÄÔ∏è', desc: 'Clear sky', bg: 'clear' },
            1: { icon: 'üå§Ô∏è', desc: 'Mainly clear', bg: 'clear' },
            2: { icon: '‚õÖ', desc: 'Partly cloudy', bg: 'cloudy' },
            3: { icon: '‚òÅÔ∏è', desc: 'Overcast', bg: 'cloudy' },
            45: { icon: 'üå´Ô∏è', desc: 'Fog', bg: 'cloudy' },
            48: { icon: 'üå´Ô∏è', desc: 'Depositing rime fog', bg: 'cloudy' },
            51: { icon: 'üåßÔ∏è', desc: 'Light drizzle', bg: 'rainy' },
            53: { icon: 'üåßÔ∏è', desc: 'Moderate drizzle', bg: 'rainy' },
            55: { icon: 'üåßÔ∏è', desc: 'Dense drizzle', bg: 'rainy' },
            56: { icon: 'üåßÔ∏è', desc: 'Light freezing drizzle', bg: 'rainy' },
            57: { icon: 'üåßÔ∏è', desc: 'Dense freezing drizzle', bg: 'rainy' },
            61: { icon: 'üåßÔ∏è', desc: 'Slight rain', bg: 'rainy' },
            63: { icon: 'üåßÔ∏è', desc: 'Moderate rain', bg: 'rainy' },
            65: { icon: 'üåßÔ∏è', desc: 'Heavy rain', bg: 'rainy' },
            66: { icon: 'üåßÔ∏è', desc: 'Light freezing rain', bg: 'rainy' },
            67: { icon: 'üåßÔ∏è', desc: 'Heavy freezing rain', bg: 'rainy' },
            71: { icon: 'üå®Ô∏è', desc: 'Slight snow', bg: 'snowy' },
            73: { icon: 'üå®Ô∏è', desc: 'Moderate snow', bg: 'snowy' },
            75: { icon: '‚ùÑÔ∏è', desc: 'Heavy snow', bg: 'snowy' },
            77: { icon: 'üå®Ô∏è', desc: 'Snow grains', bg: 'snowy' },
            80: { icon: 'üå¶Ô∏è', desc: 'Slight rain showers', bg: 'rainy' },
            81: { icon: 'üå¶Ô∏è', desc: 'Moderate rain showers', bg: 'rainy' },
            82: { icon: 'üåßÔ∏è', desc: 'Violent rain showers', bg: 'rainy' },
            85: { icon: 'üå®Ô∏è', desc: 'Slight snow showers', bg: 'snowy' },
            86: { icon: 'üå®Ô∏è', desc: 'Heavy snow showers', bg: 'snowy' },
            95: { icon: '‚õàÔ∏è', desc: 'Thunderstorm', bg: 'stormy' },
            96: { icon: '‚õàÔ∏è', desc: 'Thunderstorm with slight hail', bg: 'stormy' },
            99: { icon: '‚õàÔ∏è', desc: 'Thunderstorm with heavy hail', bg: 'stormy' }
        };

        // Convert Celsius to Fahrenheit
        function cToF(celsius) {
            return (celsius * 9/5) + 32;
        }

        // Convert km/h to mph
        function kmhToMph(kmh) {
            return kmh * 0.621371;
        }

        // Get weather info from code
        function getWeatherInfo(code) {
            return weatherCodes[code] || { icon: 'üå°Ô∏è', desc: 'Unknown', bg: 'clear' };
        }

        // Format temperature with both units
        function formatTemp(celsius, showBoth = true) {
            const c = Math.round(celsius);
            const f = Math.round(cToF(celsius));
            if (showBoth) {
                return `${c}¬∞C / ${f}¬∞F`;
            }
            return { c: `${c}¬∞C`, f: `${f}¬∞F` };
        }

        // Get day name from date
        function getDayName(dateStr, short = false) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            }
            if (date.toDateString() === tomorrow.toDateString()) {
                return 'Tomorrow';
            }

            return date.toLocaleDateString('en-US', { weekday: short ? 'short' : 'long' });
        }

        // Format hour
        function formatHour(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
        }

        // Check if it's night time
        function isNight(sunrise, sunset) {
            const now = new Date();
            const sunriseTime = new Date(sunrise);
            const sunsetTime = new Date(sunset);
            return now < sunriseTime || now > sunsetTime;
        }

        // Get location name from coordinates
        async function getLocationName(lat, lon) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
                );
                const data = await response.json();
                const city = data.address.city || data.address.town || data.address.village || data.address.county;
                const country = data.address.country_code?.toUpperCase();
                return city ? `${city}${country ? ', ' + country : ''}` : 'Your Location';
            } catch {
                return 'Your Location';
            }
        }

        // Fetch weather data
        async function fetchWeather(lat, lon) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,pressure_msl,uv_index&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max,precipitation_sum&timezone=auto&forecast_days=7`;

            const response = await fetch(url);
            if (!response.ok) throw new Error('Weather data unavailable');
            return response.json();
        }

        // Render weather UI
        function renderWeather(data, locationName) {
            const current = data.current;
            const daily = data.daily;
            const hourly = data.hourly;
            const weatherInfo = getWeatherInfo(current.weather_code);

            // Set background based on weather and time
            document.documentElement.className = '';
            const night = isNight(daily.sunrise[0], daily.sunset[0]);
            if (weatherInfo.bg === 'clear') {
                document.documentElement.classList.add(night ? 'clear-night' : 'clear-day');
            } else {
                document.documentElement.classList.add(weatherInfo.bg);
            }

            // Format current datetime
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            // Get next 24 hours of hourly data
            const currentHour = new Date().getHours();
            const startIndex = hourly.time.findIndex(t => new Date(t).getHours() === currentHour);
            const hourlyData = [];
            for (let i = startIndex; i < startIndex + 24 && i < hourly.time.length; i++) {
                hourlyData.push({
                    time: hourly.time[i],
                    temp: hourly.temperature_2m[i],
                    code: hourly.weather_code[i]
                });
            }

            const temps = formatTemp(current.temperature_2m, false);
            const feelsLike = formatTemp(current.apparent_temperature);
            const windKmh = Math.round(current.wind_speed_10m);
            const windMph = Math.round(kmhToMph(current.wind_speed_10m));

            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="location">${locationName}</div>
                    <div class="datetime">${dateStr} ‚Ä¢ ${timeStr}</div>
                </div>

                <div class="current-weather">
                    <div class="weather-icon">${weatherInfo.icon}</div>
                    <div class="condition">${weatherInfo.desc}</div>
                    <div class="temperature-main">
                        <span class="temp-celsius">${temps.c}</span>
                        <span class="temp-divider">/</span>
                        <span class="temp-fahrenheit">${temps.f}</span>
                    </div>
                    <div class="feels-like">Feels like ${feelsLike}</div>
                </div>

                <div class="hourly-forecast">
                    <div class="forecast-title">Hourly Forecast</div>
                    <div class="hourly-list">
                        ${hourlyData.map((h, i) => {
                            const hTemps = formatTemp(h.temp, false);
                            return `
                                <div class="hourly-item">
                                    <div class="hourly-time">${i === 0 ? 'Now' : formatHour(h.time)}</div>
                                    <div class="hourly-icon">${getWeatherInfo(h.code).icon}</div>
                                    <div class="hourly-temp">${hTemps.c}</div>
                                    <div class="hourly-temp-secondary">${hTemps.f}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div class="details-grid">
                    <div class="detail-card">
                        <div class="detail-icon">üí®</div>
                        <div class="detail-label">Wind</div>
                        <div class="detail-value">${windKmh} km/h</div>
                        <div class="detail-secondary">${windMph} mph</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon">üíß</div>
                        <div class="detail-label">Humidity</div>
                        <div class="detail-value">${current.relative_humidity_2m}%</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon">üå°Ô∏è</div>
                        <div class="detail-label">Pressure</div>
                        <div class="detail-value">${Math.round(current.pressure_msl)} hPa</div>
                        <div class="detail-secondary">${(current.pressure_msl * 0.02953).toFixed(2)} inHg</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon">‚òÄÔ∏è</div>
                        <div class="detail-label">UV Index</div>
                        <div class="detail-value">${current.uv_index}</div>
                        <div class="detail-secondary">${getUVLevel(current.uv_index)}</div>
                    </div>
                </div>

                <div class="forecast">
                    <div class="forecast-title">7-Day Forecast</div>
                    <div class="forecast-list">
                        ${(() => {
                            // Filter to start from today and show 7 days
                            const today = new Date();
                            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                            const startIdx = daily.time.findIndex(d => d >= todayStr);
                            const forecastDays = daily.time.slice(startIdx, startIdx + 7);

                            return forecastDays.map((date, idx) => {
                                const i = startIdx + idx;
                                const dayInfo = getWeatherInfo(daily.weather_code[i]);
                                const high = formatTemp(daily.temperature_2m_max[i], false);
                                const low = formatTemp(daily.temperature_2m_min[i], false);
                                const precip = daily.precipitation_sum[i];
                                const precipDisplay = precip > 0 ? `${precip.toFixed(1)} mm` : '';
                                return `
                                    <div class="forecast-day">
                                        <div class="forecast-day-name">${getDayName(date)}</div>
                                        <div class="forecast-icon">${dayInfo.icon}</div>
                                        <div class="forecast-rain">${precipDisplay}</div>
                                        <div class="forecast-temps">
                                            <span class="forecast-high">${high.c} / ${high.f}</span>
                                            <span class="forecast-low">${low.c} / ${low.f}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        })()}
                    </div>
                </div>
            `;
        }

        // Get UV level description
        function getUVLevel(uv) {
            if (uv <= 2) return 'Low';
            if (uv <= 5) return 'Moderate';
            if (uv <= 7) return 'High';
            if (uv <= 10) return 'Very High';
            return 'Extreme';
        }

        // Show error state
        function showError(message) {
            document.getElementById('app').innerHTML = `
                <div class="error">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-message">${message}</div>
                    <button class="retry-button" onclick="init()">Try Again</button>
                </div>
            `;
        }

        // Initialize app
        async function init() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.classList.add('spinning');

            document.getElementById('app').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Getting your location...</p>
                </div>
            `;

            try {
                // Get user location
                const position = await new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes cache
                    });
                });

                const { latitude, longitude } = position.coords;

                // Update loading message
                document.querySelector('.loading p').textContent = 'Fetching weather data...';

                // Fetch weather and location name in parallel
                const [weatherData, locationName] = await Promise.all([
                    fetchWeather(latitude, longitude),
                    getLocationName(latitude, longitude)
                ]);

                renderWeather(weatherData, locationName);
            } catch (error) {
                console.error('Error:', error);
                if (error.code === 1) {
                    showError('Location access denied. Please enable location services to use this app.');
                } else if (error.code === 2) {
                    showError('Unable to determine your location. Please try again.');
                } else if (error.code === 3) {
                    showError('Location request timed out. Please try again.');
                } else {
                    showError('Unable to load weather data. Please check your connection and try again.');
                }
            } finally {
                refreshBtn.classList.remove('spinning');
            }
        }

        // Refresh button handler
        document.getElementById('refresh-btn').addEventListener('click', init);

        // Start app
        init();
    </script>
</body>
</html>
